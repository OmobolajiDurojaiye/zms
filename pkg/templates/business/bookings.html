{% extends "business/dashboard.html" %} {% block extra_style %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/business/booking.css') }}"
/>
<style>
  /* Styles for the new View Availability Modal */
  .availability-slot {
    padding: 8px;
    margin-bottom: 5px;
    border-radius: 4px;
    border: 1px solid #eee;
  }
  .availability-slot.type-available {
    background-color: #e6ffed;
    border-left: 3px solid #28a745;
  }
  .availability-slot.type-break {
    background-color: #fff3cd;
    border-left: 3px solid #ffc107;
  }
  .availability-slot.type-blocked_override {
    background-color: #f8d7da;
    border-left: 3px solid #dc3545;
  }
  #availabilitySlotsContainer .no-availability {
    color: #6c757d;
    font-style: italic;
  }
</style>
{% endblock extra_style %} {% block page_title %}Booking Management{% endblock
%} {% block header_quick_actions %}
<div class="booking-filters">
  <select
    id="bookingDateFilter"
    class="filter-select"
    aria-label="Filter bookings by date"
  >
    <option value="today" selected>Today</option>
    <option value="tomorrow">Tomorrow</option>
    <option value="this_week">This Week</option>
    <option value="all_upcoming">All Upcoming</option>
  </select>
  <!-- New Booking Button Removed -->
  <a
    href="{{ url_for('business.manage_availability') }}"
    class="btn btn-secondary"
  >
    <i class="fas fa-business-time"></i>
    Set Availability
  </a>
</div>
{% endblock %} {% block page_content %}
<section id="bookings" class="content-section active">
  <div class="bookings-layout">
    <div class="booking-calendar-container card-style">
      <h3 id="calendarHeader" class="card-header-style">
        <span id="calendarMonthYear"
          >{{ current_calendar_month_name }} {{ current_calendar_year_val
          }}</span
        >
        <span class="calendar-controls">
          <button
            id="prevMonthBtn"
            class="calendar-nav-btn"
            aria-label="Previous Month"
          >
            <i class="fas fa-chevron-left"></i>
          </button>
          <button id="todayBtn" class="calendar-nav-btn" aria-label="Today">
            Today
          </button>
          <button
            id="nextMonthBtn"
            class="calendar-nav-btn"
            aria-label="Next Month"
          >
            <i class="fas fa-chevron-right"></i>
          </button>
        </span>
      </h3>
      <div id="calendarView" class="calendar-grid">
        <!-- Calendar will be rendered here by FullCalendar.io -->
      </div>
    </div>

    <div class="upcoming-appointments-container card-style">
      <h3 id="appointmentsListTitle" class="card-header-style">
        Today's Appointments
      </h3>
      <div id="appointmentList" class="appointment-list">
        {% if todays_bookings %} {% for booking in todays_bookings %}
        <div class="appointment-item" data-booking-id="{{ booking.id }}">
          <div class="appointment-time">
            {{ booking.start_datetime.strftime('%I:%M %p') }}
          </div>
          <div class="appointment-details">
            <h4>{{ booking.client_display_name }}</h4>
            <p>Service: {{ booking.service.name }}</p>
            <span
              class="appointment-status status-{{ booking.status | lower | replace('_', '-') }}"
              >{{ booking.status | replace('_', ' ') | title }}</span
            >
          </div>
          <div class="appointment-actions">
            <button
              class="btn-icon btn-contact-client"
              aria-label="Contact Client"
              title="Contact Client ({{ booking.guest_phone_number or (booking.client.phone_number if booking.client else 'N/A') }})"
              data-phone="{{ booking.guest_phone_number or (booking.client.phone_number if booking.client else '') }}"
              data-email="{{ booking.guest_email or (booking.client.email if booking.client else '') }}"
            >
              <i class="fas fa-phone"></i>
            </button>
            <button
              class="btn-icon btn-edit-booking"
              aria-label="Edit Booking"
              title="Edit Booking"
              data-booking-id="{{ booking.id }}"
            >
              <i class="fas fa-edit"></i>
            </button>
            <button
              class="btn-icon btn-cancel-booking btn-icon-danger"
              aria-label="Cancel Booking"
              title="Cancel Booking"
              data-booking-id="{{ booking.id }}"
            >
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
        </div>
        {% endfor %} {% else %}
        <p class="no-appointments">No appointments scheduled for today.</p>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<!-- New Booking Modal Removed -->

<!-- View Availability Modal -->
<div id="viewAvailabilityModal" class="modal">
  <div class="modal-content">
    <span class="close-button" id="closeViewAvailabilityModal" title="Close"
      >Ã—</span
    >
    <h2>Availability for <span id="availabilityModalDate"></span></h2>
    <div id="availabilitySlotsContainer" style="margin-bottom: 20px">
      <!-- Availability slots will be loaded here by JS -->
      <p>Loading availability...</p>
    </div>
    <div class="form-actions" style="text-align: right">
      <a
        href="{{ url_for('business.manage_availability') }}"
        class="btn btn-primary"
        >Manage General Availability</a
      >
      <button
        type="button"
        class="btn btn-secondary"
        id="cancelViewAvailabilityModal"
      >
        Close
      </button>
    </div>
  </div>
</div>

<!-- Placeholder for Edit Booking Modal (similar structure to New Booking Modal) -->
<!-- <div id="editBookingModal" class="modal"> ... </div> -->

{% endblock %} {% block page_scripts %} {{ super() }}
<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<!-- Day.js for date manipulation -->
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/weekday.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/localeData.js"></script>
<script>
  dayjs.extend(window.dayjs_plugin_weekday);
  dayjs.extend(window.dayjs_plugin_localeData);
</script>
<script>
  // Pass URLs and initial data from Flask to JS
  var getCalendarBookingsUrl =
    "{{ url_for('business.get_calendar_bookings_data') }}";
  var getAvailabilityOnDateUrl =
    "{{ url_for('business.get_availability_for_date') }}"; // New URL
  var cancelBookingBaseUrl = "{{ url_for('business.bookings_overview') }}"; // Base path, JS will append /<id>/cancel
  var initialTodayISO = "{{ today_date_iso }}"; // Passed from Python route
</script>
<script src="{{ url_for('static', filename='js/business/booking.js') }}"></script>
{% endblock %}
